<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>GEODES - Model transformation editor</title>
    <link rel="stylesheet" href="styles/joint.min.css" />
    <link rel="stylesheet" href="test_cd.css" />
    <link rel="stylesheet" href="styles/jquery-confirm.min.css" />
    <script src="lib/jquery.js"></script>
    <script src="lib/lodash.js"></script>
    <script src="lib/backbone.js"></script>
    <script src="lib/joint.min.js"></script>
    <script src="lib/joint.shapes.tm.js"></script>
    <script src="lib/joint.shapes.cd.js"></script>
    <script src="lib/joint.shapes.fragment.js"></script>
    <script src="lib/jquery-confirm.min.js"></script>

</head>
<body>
    <h1>Model transformation editor</h1>

    <div id="holder"></div>

    <script type="text/javascript">
        var graph = new joint.dia.Graph();

        var paper = new joint.dia.Paper({
            el: $('#holder'),
            width: 1200,
            height: 600,
            gridSize: 1,
            model: graph,
            interactive: { labelMove: true },
        });

        var cd       = joint.shapes.cd;
        var fragment = joint.shapes.fragment;

        var classes = {

            person: new cd.Abstract({
                position: { x:300  , y: 300 },
                size: { width: 260, height: 100 },
                name: 'Person',
                attributes: ['firstName: String','lastName: String'],

            }),

            bloodgroup: new cd.Class({
                position: { x:20  , y: 190 },
                size: { width: 220, height: 100 },
                name: 'BloodGroup',
                attributes: ['bloodGroup: String'],

            }),

            address: new cd.Class({
                position: { x:630  , y: 190 },
                size: { width: 160, height: 100 },
                name: 'Address',
                attributes: ['houseNumber: Integer','streetName: String','town: String','postcode: String'],
            }),

            man: new cd.Class({
                position: { x:200  , y: 500 },
                size: { width: 180, height: 50 },
                name: 'Man',
            }),

            woman: new cd.Class({
                position: { x:450  , y: 500 },
                size: { width: 180, height: 50 },
                name: 'Woman',
            }),

            ft: new fragment.Target({
                position: { x:700  , y: 500 },
                size: { width: 180, height: 50 },
                name: 'MyFT',
            }),

            fs: new fragment.Source({
                position: { x:700  , y: 400 },
                size: { width: 180, height: 50 },
                name: 'MyFS',
            })
        };

        _.each(classes, function(c) { graph.addCell(c); });

        var relations = [
        new cd.Reference({ 
            source: { id: classes.man.id }, 
            target: { id: classes.address.id },
            lowerBound: '0',
            upperBound: '*',
        }),
        new cd.Composition({ 
            source: { id: classes.person.id }, 
            target: { id: classes.bloodgroup.id },
            lowerBound: '0',
            upperBound: '*',
        }),
        new fragment.Trace({ source: { id: classes.ft.id }, target: { id: classes.fs.id } }),
        ];

        _.each(relations, function(r) { graph.addCell(r); });

        paper.on('cell:pointerup', function(cellView, evt, x, y) {

            // Find the first element below that is not a link nor the dragged element itself.
            var elementBelow = graph.get('cells').find(function(cell) {
            if (cell instanceof joint.dia.Link) return false; // Not interested in links.
            if (cell.id === cellView.model.id) return false; // The same element as the dropped one.
            if (cell.getBBox().containsPoint(g.point(x, y))) {
                return true;
            }
            return false;
        });

            // If the two elements are connected already, don't
            // connect them again (this is application specific though).
            if (elementBelow && !_.contains(graph.getNeighbors(elementBelow), cellView.model)) {

            // Source fragment --- Target fragment
            if (elementBelow instanceof fragment.Target && cellView.model instanceof fragment.Source) {
                graph.addCell(new fragment.Trace({
                    source: { id: cellView.model.id }, target: { id: elementBelow.id },
                }));
                // Move the element a bit to the side.
                cellView.model.translate(-200, 0);
            }

            if (elementBelow instanceof fragment.Source && cellView.model instanceof cd.Class) {
                console.log(elementBelow.attributes);
                elementBelow.attributes.sourceReferences.push(`Class : ${cellView.model.attributes.name}`);
                // Loop on class attributes
                elementBelow.updateRectangles();
                elementBelow.trigger('fragment-update');
                cellView.model.translate(-200, 0);
            }

            // Class --- Class
            if (elementBelow instanceof cd.Class && cellView.model instanceof cd.Class) {
                $.confirm({
                    title: 'Confirm',
                    content: 'Which link do you want to draw?',
                    useBootstrap: false,
                    type: 'dark',
                    closeIcon: true,
                    boxWidth: '20%',
                    animation: 'top',
                    backgroundDismiss: true,
                    buttons: {
                        reference: {
                            text: 'Reference',
                            btnClass: 'btn-dark',
                            keys: ['enter','r'],
                            action: function(){
                                graph.addCell(new cd.Reference({
                                    source: { id: cellView.model.id }, target: { id: elementBelow.id },
                                    lowerBound: '0',
                                    upperBound: '*',
                                }));
                                cellView.model.translate(-200, 0);
                            }
                        },
                        composition: {
                            text: 'Composition',
                            btnClass: 'btn-dark',
                            keys: ['shift','c'],
                            action: function(){
                                graph.addCell(new cd.Composition({
                                    source: { id: cellView.model.id }, target: { id: elementBelow.id },
                                    lowerBound: '0',
                                    upperBound: '*',
                                }));
                                cellView.model.translate(-200, 0);
                            }
                        }
                    }
                });
            }

        }
    });
</script>
</body>
</html>